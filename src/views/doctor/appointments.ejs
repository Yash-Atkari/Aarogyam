<%- layout("./layouts/doctorboilerplate") %>

<style>
  .appointments-container {
        max-width: 100%;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
  /* Table Styles */
    .appointments-table {
        width: 100%;
        border-collapse: collapse;
    }

    .appointments-table th, .appointments-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .appointments-table th {
        background-color: #f8f9fa;
    }

    .doctor-name {
        color: #007bff;
        font-weight: bold;
    }

    .actions .btn {
        margin-right: 5px;
    }
</style>

<div class="container">
  <h2 class="">Doctor Appointments</h2>
  <!-- Search and Filter Section -->
    <form id="filterForm" class="mt-4" method="GET" action="/doctor/filterappointments">
      <div class="row g-2">
          <div class="col-md-3">
              <input type="text" class="form-control" name="search" placeholder="Search by Patient, Reason, Disease">
          </div>
          <div class="col-md-2">
              <input type="date" class="form-control" name="date">
          </div>
          <div class="col-md-2">
              <select class="form-control" name="status">
                  <option value="" selected disabled>Search by Status</option>
                  <option value="pending">Pending</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
              </select>
          </div>
          <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">Filter</button>
          </div>
        </div>
    </form>

  <div class="appointments-container container table-responsive mt-4">
  
    <table class="appointments-table">
      <thead>
        <tr>
          <th>Sr. No.</th>
          <th>Patient</th>
          <th>Gender</th>
          <th>Reason</th>
          <th>Date</th>
          <th>Time</th>
          <th>Disease</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% if (appointments.length === 0) { %>
          <tr>
            <td colspan="8">No appointments found</td>
          </tr>
        <% } else { %>
          <% appointments.forEach((appointment, idx) => { %>
            <tr>
              <td><%= idx+1 %></td>
              <td><%= appointment.patientId ? (appointment.patientId.fullName || appointment.patientId.username) : "N/A" %></td>
              <td><%= appointment.patientId ? appointment.patientId.gender : "N/A" %></td>
              <td><%= appointment.reason ? appointment.reason : "N/A" %></td>
              <td><%= new Date(appointment.date).toLocaleDateString() %></td>
              <td><%= appointment.timeSlot ? appointment.timeSlot : "N/A" %></td>
              <td><%= appointment.disease || "N/A" %></td>
              <td><%= appointment.status %></td>
              <td class="actions">
                <div class="d-flex">
                  <!-- <a href="/doctor/appointments/addAppointmentDetails/<%= appointment._id %>" 
                    class="btn btn-primary <%= appointment.status === 'pending' ? 'disabled' : '' %>">
                    <i class="fa-solid fa-plus"></i>
                  </a> -->

                  <a href="/doctor/appointments/edit/<%= appointment._id %>" 
                    class="btn btn-secondary <%= appointment.status === 'pending' ? 'disabled' : '' %>">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </a>

                  <button type="button" class="btn btn-success" 
                          <%= appointment.status !== 'pending' ? 'disabled' : '' %>
                          data-bs-toggle="modal" data-bs-target="#confirmModal" 
                          onclick="setAppointmentId('<%= appointment._id %>')">
                    <i class="fa-solid fa-circle-check"></i>
                  </button>
                </div>   
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelModalLabel">Appointment Confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to confirm this appointment?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <form id="confirmForm" method="POST">
          <button type="submit" class="btn btn-danger">Yes, Confirm</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function setAppointmentId(appointmentId) {
    document.getElementById("confirmForm").action = `/doctor/appointments/confirm/${appointmentId}`;
  }
</script>
