<%- layout("./layouts/doctorboilerplate") %>

<style>
    .form-container {
      background: hsl(213, 85%, 97%);
      padding: 2em;
      border-radius: 30px;
      box-shadow: 0 0 2em hsl(231, 62%, 94%);
      width: 100%;
      max-width: 900px;
      margin: auto;
      margin-bottom: 2rem;
    }

    h1 {
      font-weight: 600;
      color: #333;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .form-label {
      font-weight: 500;
    }

    .form-control {
      border-radius: 20px;
      padding: 1em;
      box-shadow: 0 0 1em hsl(231, 62%, 94%);
      border: none;
    }

    .form-control:focus {
      box-shadow: 0 0 0 2px #1A73E8;
      outline: none;
    }

    .btn-primary {
      padding: 1em;
      background: #1A73E8;
      color: #fff;
      border: none;
      border-radius: 30px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px #1A73E8;
    }

    @media (max-width: 768px) {
      .form-container {
        padding: 1.5em;
      }
    }

    .alert {
        position: inherit;
    }
  </style>

<div class="container">
    <form action="/doctor/profile/<%= doctor._id %>" method="POST" class="form-container needs-validation" novalidate>
        <div class="row">
          <div class="col-12">
            <h1 class="fs-2">Update Profile</h1>
          </div>
        </div>
        
        <!-- Full Name -->
        <div class="mb-3">
            <label for="fullName" class="form-label">Full Name <span class="text-danger">*</span></label>
            <input type="text" name="doctor[fullName]" id="fullName" value="<%= doctor.fullName %>" placeholder="Enter full name" class="form-control" required>
            <div class="invalid-feedback">Please provide a full name.</div>
        </div>

        <!-- Email -->
        <div class="mb-3">
            <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
            <input type="email" name="doctor[email]" id="email" value="<%= doctor.email %>" placeholder="Enter email address" class="form-control" disabled required>
            <div class="invalid-feedback">Please provide a valid email address.</div>
        </div>

        <!-- Qualification -->
        <div class="mb-3">
            <label for="qualification" class="form-label">Qualification</label>
            <input type="text" name="doctor[qualification]" id="qualification" value="<%= doctor.qualification %>" placeholder="Enter qualification" class="form-control">
        </div>
      <div class="row">
          <!-- Specialization -->
          <div class="mb-3 col-md-6">
            <label for="specialization" class="form-label">Specialization <span class="text-danger">*</span></label>
            <input type="text" name="doctor[specialization]" id="specialization" value="<%= doctor.specialization %>" placeholder="Enter specialization" class="form-control" required>
            <div class="invalid-feedback">Please provide a specialization.</div>
          </div>
          <!-- Experience -->
          <div class="mb-3 col-md-6">
            <label for="experience" class="form-label">Years of Experience <span class="text-danger">*</span></label>
            <input type="number" name="doctor[experience]" id="experience" value="<%= doctor.experience %>" placeholder="Enter years of experience" class="form-control" required>
            <div class="invalid-feedback">Please provide the years of experience.</div>
          </div>
        </div>
      
        <div class="row">
          <!-- Hospital -->
          <div class="mb-3 col-md-6">
            <label for="hospital" class="form-label">Hospital Name <span class="text-danger">*</span></label>
            <input type="text" name="doctor[hospital]" id="hospital" value="<%= doctor.hospital %>" placeholder="Enter hospital name" class="form-control" required>
            <div class="invalid-feedback">Please provide the hospital name.</div>
          </div>
          <!-- Consultant Fees -->
          <div class="mb-3 col-md-6">
            <label for="consultantFees" class="form-label">Consultant Fees <span class="text-danger">*</span></label>
            <input type="number" name="doctor[consultantFees]" id="consultantFees" value="<%= doctor.consultantFees %>" placeholder="Enter fees" class="form-control" required>
            <div class="invalid-feedback">Please provide consultant fees.</div>
          </div>
        </div>
      
        <!-- Phone -->
        <div class="mb-3">
          <label for="phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
          <input type="text" name="doctor[phone]" id="phone" value="<%= doctor.phone %>" placeholder="Enter phone number" class="form-control" required>
          <div class="invalid-feedback">Please provide a valid phone number.</div>
        </div>
        <!-- Availability Slots -->
        <div class="mb-3">
          <label class="form-label">Availability Slots</label>

          <div id="slots-container">
            <% if (doctor.availabilitySlots && doctor.availabilitySlots.length > 0) { %>
              <% doctor.availabilitySlots.forEach(function(slot, index) { %>
                <hr>
                <div class="row mb-2">
                    <div class="col-md-4"><label for="date" class="form-label">Date</label></div>
                    <div class="col-md-3"><label for="startTime" class="form-label">Start time</label></div>
                    <div class="col-md-3"><label for="endTime" class="form-label">End time</label></div>
                    <div class="col-md-2"><label for="action" class="form-label">Action</label></div>
                </div>
                <div class="row mb-2 slot-item">
                  <div class="col-md-4">
                    <input 
                    type="date" 
                    name="doctor[availabilitySlots][<%= index %>][date]" 
                    value="<%= slot.date ? slot.date.toISOString().split('T')[0] : '' %>" 
                    class="form-control" 
                    min="<%= new Date().toLocaleString('en-CA', { timeZone: 'Asia/Kolkata' }).split(',')[0] %>"
                    required
                  >
                  </div>
                  <div class="col-md-3">
                    <input type="time" name="doctor[availabilitySlots][<%= index %>][startTime]" value="<%= slot.startTime %>" class="form-control" required>
                  </div>
                  <div class="col-md-3">
                    <input type="time" name="doctor[availabilitySlots][<%= index %>][endTime]" value="<%= slot.endTime %>" class="form-control" required>
                  </div>
                  <div class="col-md-2">
                    <button type="button" class="btn btn-danger remove-slot"><i class="fa-solid fa-trash"></i></button>
                  </div>
                </div>
              <% }) %>
            <% } %>
          </div>
          <div class="alert alert-warning mb-2" role="alert">
            ⚠️ <strong>Note:</strong> Please add availability slots only for future times (greater than current IST).
          </div>
          <button type="button" class="btn btn-secondary" id="add-slot">Add Slot</button>
        </div>

        <button type="submit" class="btn btn-primary">Update Profile</button>
    </form>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    let slotsContainer = document.getElementById("slots-container");
    let addSlotBtn = document.getElementById("add-slot");

    // Get today's date in YYYY-MM-DD format
    const today = new Date().toLocaleDateString("en-CA"); // en-CA gives YYYY-MM-DD
    console.log(today);

    addSlotBtn.addEventListener("click", () => {
      let index = slotsContainer.querySelectorAll(".slot-item").length;

      let slotHtml = `
        <hr>
        <div class="row mb-2 slot-item">
          <div class="col-md-4">
            <input type="date" name="doctor[availabilitySlots][${index}][date]" class="form-control" min="${today}" required>
          </div>
          <div class="col-md-3">
            <input type="time" name="doctor[availabilitySlots][${index}][startTime]" class="form-control" required>
          </div>
          <div class="col-md-3">
            <input type="time" name="doctor[availabilitySlots][${index}][endTime]" class="form-control" required>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger remove-slot"><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>
      `;

      slotsContainer.insertAdjacentHTML("beforeend", slotHtml);
    });

    // Remove slot
    slotsContainer.addEventListener("click", function(e) {
      if (e.target.classList.contains("remove-slot")) {
        e.target.closest(".slot-item").remove();
      }
    });
  });
</script>
